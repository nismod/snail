import pandana
from igraph import Graph
import geopandas as gpd
from pandas import DataFrame
import matplotlib.pyplot as plt
import numpy as np

gdf = gpd.read_file("jamaica_roads.gpkg")

from_node = [int(node_id[6:]) for node_id in gdf["from_node"]]
to_node = [int(node_id[6:]) for node_id in gdf["to_node"]]

nids, idxs = np.unique(from_node + to_node, return_index=True)
x = []
y = []
for nid, idx in zip(nids, idxs):
    linestr = gdf.loc[idx % len(from_node), "geometry"]
    coords = linestr.coords[int(-1 * (idx // len(from_node)))]
    x.append(coords[0])
    y.append(coords[1])

nodes = DataFrame({"x": x, "y": y}, index=nids)
edges = DataFrame(
    {"from": from_node, "to": to_node, "weight": gdf["length_km"].values}
)
net = pandana.Network(
    nodes["x"], nodes["y"], edges["from"], edges["to"], edges[["weight"]]
)

start_node_idx = 15891
sp = net.shortest_path(0, start_node_idx, imp_name="weight")
edges = gdf.loc[:, ["from_node", "to_node"]]
g = Graph.DataFrame(edges, directed=False)
igraph_nodes = [g.vs.find(name="roadn_" + str(i)).index for i in sp]
epath = g.get_eids(path=igraph_nodes, directed=False)

base = gdf.plot()
for path in sp:
    # Select linestrings according to edge IDs making the path
    # edge ID are 1to1 with row id in dataframe
    sub_gdf = gdf.iloc[epath, :]
    sub_gdf.plot(ax=base, color="green", linewidth=5)
plt.show()

# edge list
# [8649, 8646, 8643, 8642, 8592, 10194, 10192, 10193, 10187, 10190, 10189, 10188, 10186, 10177, 10191, 10184, 10182, 10183, 10185, 10180, 10179, 10178, 10181, 12907, 12897, 12911, 12912, 12913, 12906, 12909, 12905, 12904, 12900, 12899, 12901, 12908, 12910, 13394, 13397, 13406, 13403, 13404, 13407, 13387, 13395, 13427, 13428, 13426, 10211, 10208, 10351, 10346, 10350, 10345, 10344, 10349, 10348, 10354, 10347, 10343, 10352, 10353, 10356, 10365, 10364, 10361, 10360, 10359, 10358, 10357, 10367, 10363, 10374, 10379, 10355, 10380, 10375, 10376, 10378, 10381, 10377, 10370, 10368, 10369, 10372, 10373, 10362, 10366, 10371, 10632, 10646, 10641, 10650, 10642, 10633, 10649, 10637, 10651, 10648, 10652, 10644, 10640, 10643, 10645, 10647, 10638, 10639, 10634, 10635, 10636, 10654, 10653, 8735, 8731, 8732, 14077, 14084, 14078, 14074, 14075, 14086, 14085, 14082, 14076, 14083, 14079, 14080, 14081, 8811, 8764, 8778, 14180, 14179, 14185, 14186, 14187, 14188, 14184, 14183, 14182, 14181, 14178, 14177, 10462, 11025, 11027, 11028, 11021, 11037, 11035, 11032, 11040, 11036, 11019, 11033, 11034, 11026, 11038, 11039, 11029, 11022, 11023, 11020, 11018, 11031, 11030, 11024, 14221, 14220, 14213, 14212, 14216, 14214, 14218, 14202, 14203, 14204, 14225, 14222, 14201, 14205, 14208, 14207, 14209, 14211, 14210, 10958, 10976, 14576, 14578, 14577, 14517, 14504, 14513, 14505, 14510, 14506, 14507, 14512, 14524, 14526, 14522, 14525, 14527, 14528, 14523, 14529, 14530, 14624, 14607, 14628, 14629, 14632, 14634, 14631, 14627, 14630, 14633, 10813, 10810, 10809, 10806, 10807, 10812, 10805, 10817, 10818, 14926, 14917, 14914, 14958, 14959, 14960, 15055, 15054, 15038, 15059, 15060, 14966, 14965, 14961, 14970, 14964, 14963, 14967, 14968, 14962, 14969, 15003, 14991, 14984, 14980, 14972, 14992, 14993, 15004, 14978, 14985, 14973, 14974, 15002, 14994, 14996, 14975, 14979, 14987, 14981, 14995, 14990, 14989, 14997, 14998, 14999, 14971, 10837, 10835, 10829, 10834, 10836, 10839, 10841, 10825, 10833, 10824, 10827, 9219, 9220, 9227, 9226, 9197, 9198, 9216, 9207, 9203, 9202, 9214, 9225, 9210, 9208, 9201, 9200, 9211, 9195, 9212, 9206, 9205, 9204, 9232, 9215, 15817, 15818, 15815, 15816, 15814, 15829, 15991, 15990, 15996, 15993, 15992, 15999, 15997, 15994, 16000, 15995, 15987, 15986, 15985, 16001, 15998, 15988, 15989, 15984, 16009, 16012, 16013, 16010, 16011, 16007, 16005, 16006, 16004, 16003, 16002, 16008, 16098, 16100, 16105, 16102, 16083, 16085, 16086, 16088, 16087, 16099, 16091, 16173, 16174, 16179, 16177, 16171, 16178, 16168, 16172, 16176, 16169]

# vertex list
## [    0,   538,   539,  9029,  8992,  8991, 10470,     1, 10466,
#       10467, 10469, 10468, 10465, 10455, 10456, 10464, 10462, 10461,
#       10463, 10460, 10459, 10458, 10457, 10452, 12918, 12919, 12932,
#       12933, 12928, 12929, 12927, 12926, 12923, 12920, 12922, 12924,
#       12930, 12931, 13398, 13400, 13404, 13403, 13405, 13388, 13387,
#       13399, 13422, 13421, 10485, 10482, 10483, 10613, 10612, 10611,
#       10610, 10609, 10616, 10615, 10614, 10608, 10607, 10617, 10618,
#       10621, 10632, 10627, 10626, 10625, 10624, 10623, 10622, 10631,
#       10630, 10640, 10620, 10619, 10641, 10642, 10643, 10645, 10644,
#       10637, 10634, 10635, 10636, 10639, 10628, 10629, 10633, 10638,
#       10876, 10888, 10887, 10889, 10878, 10877, 10882, 10881, 10894,
#       10893, 10891, 10885, 10886, 10890, 10892, 10883, 10884, 10879,
#          24,   235, 10880, 10895,  9099,  9095,   231,  9096, 14025,
#       14026, 14020, 14021, 14022, 14030, 14029, 14023, 14024, 14027,
#       14028,   221,  9115,  9129,  9128,  9148, 14113, 14112, 14118,
#       14119, 14120, 14117, 14116, 14115, 14114, 14111, 14110, 10703,
#       10725, 11245, 11248, 11240, 11241, 11254, 11252, 11251, 11255,
#       11237, 11238, 11253, 11246, 11247, 11256, 11249, 11242, 11243,
#       11239, 11236, 11235, 11250, 11244, 11229, 14150, 14145, 14144,
#       14143, 14147, 14146, 14135, 14134, 14136, 14137, 14151, 14133,
#       14132, 14138, 14139, 14140, 14141, 14142, 11176, 11177, 11198,
#       14488,   245, 14430, 14421, 14420, 14423, 14422, 14425, 14424,
#       14426, 14431, 14441, 14437, 14438, 14442, 14443, 14439, 14440,
#         201, 14444, 14523, 14524,   211, 14535, 14538, 14537, 14533,
#       14534, 14536, 11021, 11035, 11034, 11030, 11031, 11032, 11028,
#       11029,   266, 11036, 14809, 14806, 14805, 14847, 14848, 14849,
#       14934, 14921, 14922, 14936, 14857, 14856,   254, 14850, 14855,
#       14853, 14854, 14858, 14852, 14851, 14859, 14883, 14877, 14872,
#       14861, 14862,   260, 14884, 14869, 14870, 14864, 14863, 14865,
#       14885, 14886, 14866, 14867, 14871, 14873, 14874, 14882, 14880,
#       14881, 14887,   263, 14860, 11060, 11058, 11052, 11053, 11057,
#       11059, 11062, 11048, 11047, 11046, 11045,  9572,  9573,  9574,
#        9579,  9551,  9550,  9552,  9563,  9559,  9558,  9557,  9567,
#        9566,  9564,  9556,  9555,  9554,  9547,  9546,  9562,  9561,
#         264,  9560,  9569,  9568, 15663, 15661, 15662, 15506, 15586,
#       15673, 15821, 15820, 15824, 15823, 15822, 15828, 15826, 15825,
#       15827, 15817, 15816, 15815, 15814, 15829, 15819, 15818, 15813,
#       15812, 15836, 15839, 15838, 15837, 15834, 15833, 15832, 15831,
#         506,   507, 15830, 15835, 15920, 15921, 15923, 15906, 15905,
#       15908, 15909, 15911, 15910, 15915, 15914, 15987, 15988, 15989,
#       15985, 15984, 15980, 15979, 15986, 15982, 15981])
